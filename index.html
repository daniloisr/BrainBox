<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> 
    <title>BrainBox</title>
	<link rel="stylesheet" href="lib/jquery-ui.css">
	<link rel="stylesheet" href="css/common.css" />
</head>

<body>

<div style="width:100%;height:100%;display:flex;flex-direction:column">
	<!-- Login (fixed height) -->
	<div style="flex:0 0 64px">
		<div id="MyLogin"></div>
	</div>
	<!-- Content (variable height) -->
	<div style="flex:1 0 auto">
		<div id="intro">
			<img id="logo" src="img/brainbox-logo.svg" style="text-align:center"/><br />
			<h2>Real-time collaboration</h2>
			
			<div style="display:flex">
				<div style="flex:1 1 auto"></div>
				<div style="flex:0 1 500px">
					<p>
						BrainBox is a web application by <b><a target="_blank" href="http://neuroanatomy.github.io">NAAT</a></b> to
						visualise and segment collaboratively any brain MRI dataset available online.
						Segmentations are automatically saved and can be downloaded as Nifti 2 files or
						triangular meshes. Point BrainBox to your own Nifti 2 data, or try data catalogues
						created by the community.
					</p>
					<div style="width:calc( 100% - 20px);margin-left:10px;margin-top:30px;display:flex">
						<div style="flex:1 1 auto">
							<input id="url" type="text" placeholder="Enter the URL of an MRI (.nii.gz)"></input>
						</div>
						<div style="flex:0 0 32px">
							<div id="go" onclick="goToURL()">Go</div>
						</div>
					</div>
				</div>
				<div style="flex:1 1 auto"></div>
			</div>
		</div>
		<div id="stereotaxic" style="width:512px"></div>
	</div>
	
	<!-- Space (fixed height) -->
	<div style="flex:0 0 50px">
	</div>

	<!-- Footer (fixed height) -->
	<div style="flex:0 0 100px;background-color:#000">
		<p style="width:100%;font-size:small;text-align:center"> 
			<a target="_blank" href="http://neuroanatomy.github.io">
				<img src="img/naat-bw.svg" style="width:28px;height:28px;margin-right:4px;display:inline-block;vertical-align:middle"/></a>
			<a target="_blank" href="http://neuroanatomy.github.io" class="linkNoULine">
				group de neuroanatomie appliquée et théorique
			</a>
		</p>
	</div>
</div>

<!-- 
A few brains:
http://braincatalogue.org/data/Baboon/MRI.nii.gz
https://zenodo.org/record/44855/files/MRI-n4.nii.gz
http://files.figshare.com/2284784/MRI_n4.nii.gz
http://braincatalogue.org/data/Human/MRI-n4.nii.gz
https://dl.dropboxusercontent.com/u/363467/mprage003.nii.gz
-->

<!--
<div id="myStereo"></div>
-->

<script src="lib/jquery-1.11.0.min.js"></script>
<script src="lib/jquery-ui.js"></script>
<script src="lib/jquery.ui.touch-punch.min.js"></script>
<script src="lib/pako/pako.min.js"></script>
<script src="lib/mylogin/login.js"></script>
<script src="js/brainbox.js"></script>

<script>

// Init login widget
MyLoginWidget.init($("#MyLogin"));

var params=deparam();
var version=1;

// If brainbox's call contains an url, launch atlasMaker with it,
// otherwise, present the history in localStorage if it exists.
if(params.url) {
	var fullscreen=false;
	if(params.fullscreen)
		params.fullscreen=(params.fullscreen=="true");
	
	var splash=$("<div id='splash'>");
	splash.css({position:'absolute',top:'0px',left:'0px',backgroundColor:'#222',width:'100%',height:'100%'});
	splash.append([
		" <a href='/'>",
		"  <img id='logo' src='/img/brainbox-logo.svg'/>",
		" </a>",
		" <div id='msgLog'></div>",
		"</div>"
	].join(""));
	console.log(splash);
	$('body').append(splash);
	
	params.hash=BrainBox.hash(params.url);
	BrainBox.initBrainBox(params)
	.then(function(){
		$("#intro").remove();
		$("#splash").remove();
		$("body").prepend([
			"<a href='/'>",
			" <img style='position:fixed;left:5px;top:5px;width:200px' src='/img/brainbox-logo-small.svg'/>",
			"</a>"
		].join(""));

	},function(){
		console.log("ERROR");
	});
} else {
	if(localStorage.AtlasMaker) {
		var stored=JSON.parse(localStorage.AtlasMaker);
		if(stored.version && stored.version==version) {
			var str="<br/><p><b>Recently visited</b><br/>";
			for(var i=0;i<stored.history.length;i++) {
				str+="<a href='"+location+"index.html?url="+stored.history[i].url+"'>"+stored.history[i].url+"</a><br />";
			}
			str+="</p>";
			$("#intro").append(str);
		} else {
			localStorage.clear();
		}
	}
}

function deparam() {
    var search = location.search.substring(1);
    var result = search?JSON.parse('{"' + search.replace(/&/g, '","').replace(/=/g,'":"') + '"}',
                     function(key, value) { return key===""?value:decodeURIComponent(value) }):{};
    return result;
}

// Add URL loading
$("#url").keyup(function(e) {
	if (e.keyCode == 13) {
		goToURL(e);
	}
});
function goToURL(e) {
	var url=$("#url").val();
	params.url=url;
	params.hash=BrainBox.hash(url);
	location="/index.html?url="+url;
	BrainBox.initBrainBox(params);
};
</script>

</body>
</html>
